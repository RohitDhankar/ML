python .\json_to_csv_to_sql.py


--DF-df_csv_Shape == (5555, 41)


        _id                            listing_url  ...                   weekly_price                  monthly_price
0  10006546  https://www.airbnb.com/rooms/10006546  ...                            NaN                            NaN
1  10009999  https://www.airbnb.com/rooms/10009999  ...  {'$numberDecimal': '1492.00'}  {'$numberDecimal': '4849.00'}
2   1001265   https://www.airbnb.com/rooms/1001265  ...   {'$numberDecimal': '650.00'}  {'$numberDecimal': '2150.00'}

[3 rows x 41 columns],


<class 'pandas.core.frame.DataFrame'>
RangeIndex: 5555 entries, 0 to 5554
Data columns (total 41 columns):
_id                      5555 non-null int64
listing_url              5555 non-null object
name                     5555 non-null object
summary                  5555 non-null object
space                    5555 non-null object
description              5555 non-null object
neighborhood_overview    5555 non-null object
notes                    5555 non-null object
transit                  5555 non-null object
access                   5555 non-null object
interaction              5555 non-null object
house_rules              5555 non-null object
property_type            5555 non-null object
room_type                5555 non-null object
bed_type                 5555 non-null object
minimum_nights           5555 non-null int64
maximum_nights           5555 non-null int64
cancellation_policy      5555 non-null object
last_scraped             5555 non-null object
calendar_last_scraped    5555 non-null object
first_review             4167 non-null object
last_review              4167 non-null object
accommodates             5555 non-null int64
bedrooms                 5550 non-null float64
beds                     5542 non-null float64
number_of_reviews        5555 non-null int64
bathrooms                5545 non-null object
amenities                5555 non-null object
price                    5555 non-null object
security_deposit         3471 non-null object
cleaning_fee             4024 non-null object
extra_people             5555 non-null object
guests_included          5555 non-null object
images                   5555 non-null object
host                     5555 non-null object
address                  5555 non-null object
availability             5555 non-null object
review_scores            5555 non-null object
reviews                  5555 non-null object
weekly_price             714 non-null object
monthly_price            656 non-null object
dtypes: float64(2), int64(5), object(34)
memory usage: 1.7+ MB
None


_id                        int64
listing_url               object
name                      object
summary                   object
space                     object
description               object
neighborhood_overview     object
notes                     object
transit                   object
access                    object
interaction               object
house_rules               object
property_type             object
room_type                 object
bed_type                  object
minimum_nights             int64
maximum_nights             int64
cancellation_policy       object
last_scraped              object
calendar_last_scraped     object
first_review              object
last_review               object
accommodates               int64
bedrooms                 float64
beds                     float64
number_of_reviews          int64
bathrooms                 object
amenities                 object
price                     object
security_deposit          object
cleaning_fee              object
extra_people              object
guests_included           object
images                    object
host                      object
address                   object
availability              object
review_scores             object
reviews                   object
weekly_price              object
monthly_price             object
dtype: object


--DF_df_csv_Shape= (5555, 40)


SQL Server
Microsoft Access Driver (*.mdb, *.accdb)
Microsoft Excel Driver (*.xls, *.xlsx, *.xlsm, *.xlsb)
Microsoft Access Text Driver (*.txt, *.csv)
SQL Server Native Client 11.0
SQL Server Native Client RDA 11.0
ODBC Driver 17 for SQL Server
<pyodbc.Connection object at 0x000001EF313675E0>







[listing_url],               
	[name],                      
	[summary],                   
	[space],                     
	[description],               
	[neighborhood_overview],     
	[notes],                     
	[transit],                   
	[access],                    
	[interaction],               
	[house_rules],               
	[property_type],             
	[room_type],                 
	[bed_type],                  
	[minimum_nights],             
	[maximum_nights],             
	[cancellation_policy],       
	[last_scraped],              
	[calendar_last_scraped],     
	[first_review],              
	[last_review],               
	[accommodates],               
	[bedrooms],                 
	[beds],                     
	[number_of_reviews],          
	[bathrooms],                 
	[amenities],                 
	[price],                     
	[security_deposit],          
	[cleaning_fee],              
	[extra_people],              
	[guests_included],           
	[images],                    
	[host],                      
	[address],                   
	[availability],              
	[review_scores],             
	[reviews],                   
	[weekly_price],              
	[monthly_price]         
	)





abcd@DESKTOP-3CKFT1Q MINGW64 /c/21_01/gits_done_down/jan_21_1/revopy/ML (dev_rohit)
$ git status
On branch dev_rohit
Changes to be committed:
  (use "git restore --staged <file>..." to unstage)
        new file:   Data/test_code/code_logs.log
        modified:   Data/test_code/json_to_csv_to_sql.py
        new file:   Data/test_code/listingsAndReviews.json
        new file:   Data/test_codelistingsAndReviews.json__.csv

Changes not staged for commit:
  (use "git add/rm <file>..." to update what will be committed)
  (use "git restore <file>..." to discard changes in working directory)
        deleted:    Data/test_code/listingsAndReviews.json
        deleted:    Data/test_codelistingsAndReviews.json__.csv


abcd@DESKTOP-3CKFT1Q MINGW64 /c/21_01/gits_done_down/jan_21_1/revopy/ML (dev_rohit)
$ git restore --staged /c/21_01/gits_done_down/jan_21_1/revopy/ML/Data/test_code/listingsAndReviews.json
error: pathspec 'Data/test_code/listingsAndReviews.json' did not match any file(s) known to git

abcd@DESKTOP-3CKFT1Q MINGW64 /c/21_01/gits_done_down/jan_21_1/revopy/ML (dev_rohit)


git restore --staged C:\21_01\gits_done_down\jan_21_1\revopy\ML\Data\test_codelistingsAndReviews.json__.csv

pyodbc.ProgrammingError: ('The SQL contains 40 parameter markers, but 41 parameters were supplied', 'HY000')

Traceback (most recent call last):
  File ".\json_to_csv_to_sql.py", line 173, in <module>
    csv_to_sql()
  File ".\json_to_csv_to_sql.py", line 170, in csv_to_sql
    cursor_object.executemany(sql_insert, df_records)
pyodbc.Error: ('21S01', '[21S01] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]There are fewer columns in the INSERT 
statement than values specified in the VALUES clause. The number of values in the VALUES clause must match the number of 
columns specified in the INSERT statement. (110) (SQLExecDirectW); [21S01] [Microsoft][ODBC Driver 17 for SQL Server]
[SQL Server]Statement(s) could not be prepared. (8180)')


Windows PowerShell REDIRECTION 

3>&1 2>&1 >
https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_redirection?view=powershell-7.1
*>

  Tee-Object -FilePath "c:\test\AllSystemFiles.txt" -Append 
  Tee-Object -FilePath "C:\21_01\gits_done_down\jan_21_1\revopy\ML\Data\test_code\test3.log" -Append 




TITLE: Microsoft SQL Server Management Studio
------------------------------
Error inserting data into table. (Microsoft.SqlServer.Import.Wizard)
------------------------------
ADDITIONAL INFORMATION:
Error inserting data into table. (Microsoft.SqlServer.Prose.Import)
------------------------------
Violation of PRIMARY KEY constraint 'PK_df_random'. Cannot insert duplicate key in object 'dbo.df_random'. The duplicate key value is (w*10133@gmail.com).
The statement has been terminated. (Microsoft SQL Server, Error: 2627)
For help, click: http://go.microsoft.com/fwlink?ProdName=Microsoft%20SQL%20Server&ProdVer=15.00.2000&EvtSrc=MSSQLServer&EvtID=2627&LinkId=20476
------------------------------
BUTTONS:
OK
------------------------------


===================================

Error inserting data into table. (Microsoft.SqlServer.Import.Wizard)

------------------------------
Program Location:

   at Microsoft.SqlServer.Import.Wizard.InsertData.ResultCheck(Result result)
   at Microsoft.SqlServer.Import.Wizard.InsertData.DoWork()
   at Microsoft.SqlServer.Management.TaskForms.SimpleWorkItem.Run()

===================================

Error inserting data into table. (Microsoft.SqlServer.Prose.Import)

------------------------------
Program Location:

   at Microsoft.SqlServer.Prose.Import.BcpTextSynthesis.InsertIntoDB(String inputFilePath, String tableName, String schemaName, IReadOnlyList`1 columnInfo, SqlConnection connection, Int32 batchSize, SqlTransaction transaction)
   at Microsoft.SqlServer.Prose.Import.BcpProcess.<>c__DisplayClass60_0.<CreateTableAndInsertDataIntoDb>b__0()
   at Microsoft.SqlServer.Prose.Import.BcpProcess.ExecuteOperation(Action operation)

===================================

Violation of PRIMARY KEY constraint 'PK_df_random'. Cannot insert duplicate key in object 'dbo.df_random'. The duplicate key value is (w*10133@gmail.com).
The statement has been terminated. (.Net SqlClient Data Provider)

------------------------------
For help, click: http://go.microsoft.com/fwlink?ProdName=Microsoft%20SQL%20Server&ProdVer=15.00.2000&EvtSrc=MSSQLServer&EvtID=2627&LinkId=20476

------------------------------
Server Name: DESKTOP-3CKFT1Q
Error Number: 2627
Severity: 14
State: 1
Line Number: 1










------------------------------
Program Location:

   at System.Data.SqlClient.SqlConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at System.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection, Action`1 wrapCloseInAction)
   at System.Data.SqlClient.TdsParser.ThrowExceptionAndWarning(TdsParserStateObject stateObj, Boolean callerHasConnectionLock, Boolean asyncClose)
   at System.Data.SqlClient.TdsParser.TryRun(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj, Boolean& dataReady)
   at System.Data.SqlClient.TdsParser.Run(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj)
   at System.Data.SqlClient.SqlBulkCopy.RunParser(BulkCopySimpleResultSet bulkCopyHandler)
   at System.Data.SqlClient.SqlBulkCopy.CopyBatchesAsyncContinuedOnSuccess(BulkCopySimpleResultSet internalResults, String updateBulkCommandText, CancellationToken cts, TaskCompletionSource`1 source)
   at System.Data.SqlClient.SqlBulkCopy.CopyBatchesAsyncContinued(BulkCopySimpleResultSet internalResults, String updateBulkCommandText, CancellationToken cts, TaskCompletionSource`1 source)
   at System.Data.SqlClient.SqlBulkCopy.CopyBatchesAsync(BulkCopySimpleResultSet internalResults, String updateBulkCommandText, CancellationToken cts, TaskCompletionSource`1 source)
   at System.Data.SqlClient.SqlBulkCopy.WriteToServerInternalRestContinuedAsync(BulkCopySimpleResultSet internalResults, CancellationToken cts, TaskCompletionSource`1 source)
   at System.Data.SqlClient.SqlBulkCopy.WriteToServerInternalRestAsync(CancellationToken cts, TaskCompletionSource`1 source)
   at System.Data.SqlClient.SqlBulkCopy.WriteToServerInternalAsync(CancellationToken ctoken)
   at System.Data.SqlClient.SqlBulkCopy.WriteRowSourceToServerAsync(Int32 columnCount, CancellationToken ctoken)
   at System.Data.SqlClient.SqlBulkCopy.WriteToServer(IDataReader reader)
   at Microsoft.SqlServer.Prose.Import.BcpTextSynthesis.InsertIntoDB(String inputFilePath, String tableName, String schemaName, IReadOnlyList`1 columnInfo, SqlConnection connection, Int32 batchSize, SqlTransaction transaction)



/****** Script for SelectTopNRows command from SSMS  ******/
SELECT TOP (1000) [column1]
      ,[Unnamed_0]
      ,[Col1]
      ,[Col2]
      ,[Col3]
      ,[Col4]
      ,[Col5]
      ,[Col6]
      ,[Col7]
      ,[Col8]
      ,[col_rand_floats]
      ,[col_emails]
      ,[col_date_time]
      ,[concat_cols]
  FROM [test_csv].[dbo].[df_unq_df_random]
  




TITLE: 'SqlServer' module not found
------------------------------
No SQL Server cmdlets found on this computer. 
Get the 'SqlServer' module at https://powershellgallery.com/packages/SqlServer

Start PowerShell without SQL Server cmdlets?
For help, click: https://go.microsoft.com/fwlink/?linkid=842573
------------------------------
BUTTONS:

&Yes
&No
Open PowerShell &Gallery
------------------------------







/****** Script for SelectTopNRows command from SSMS  ******/
SELECT TOP (1000) [CONSTRAINT_CATALOG]
      ,[CONSTRAINT_SCHEMA]
      ,[CONSTRAINT_NAME]
      ,[CHECK_CLAUSE]
  FROM [test_csv].[INFORMATION_SCHEMA].[CHECK_CONSTRAINTS]







  CREATE TABLE [dbo].[df_unq_df_random_1] (
[Column 0] varchar(50),
[Unnamed  0] varchar(50),
[Col1] varchar(50),
[Col2] varchar(50),
[Col3] varchar(50),
[Col4] varchar(50),
[Col5] varchar(50),
[Col6] varchar(50),
[Col7] varchar(50),
[Col8] varchar(50),
[col_rand_floats] varchar(50),
[col_emails] varchar(50),
[col_date_time] varchar(50),
[concat_cols] varchar(50)
)


Click Finish to perform the following actions: 


Destination Location : DESKTOP-3CKFT1Q
Destination Provider : SQLNCLI11

Copy rows from C:\21_01\gits_done_down\jan_21_1\revopy\ML\Data\test_code\df_unq_df_random_1.csv to [dbo].[df_unq_df_random_1]
The new target table will be created.

The package will not be saved. 
The package will be run immediately. 

Provider mapping file : C:\Program Files (x86)\Microsoft SQL Server Management Studio 18\Common7\IDE\CommonExtensions\Microsoft\SSIS\150\MappingFiles\SSIS10ToMSSQL.XML


######## FOOBAR_REPORT
The execution was successful

- Initializing Data Flow Task (Success)

- Initializing Connections (Success)

- Setting SQL Command (Success)

- Setting Source Connection (Success)

- Setting Destination Connection (Success)

- Validating (Success)
	Messages
	* Warning 0x80049304: Data Flow Task 1: Warning: Could not open global shared memory to communicate with performance DLL; data flow performance counters are not available.  To resolve, run this package as an administrator, or on the system's console.
	 (SQL Server Import and Export Wizard)
	

- Prepare for Execute (Success)

- Pre-execute (Success)
	Messages
	* Information 0x402090dc: Data Flow Task 1: The processing of file "C:\21_01\gits_done_down\jan_21_1\revopy\ML\Data\test_code\df_unq_df_random_1.csv" has started.
	 (SQL Server Import and Export Wizard)
	

- Executing (Success)
	Messages
	* Information 0x402090de: Data Flow Task 1: The total number of data rows processed for file "C:\21_01\gits_done_down\jan_21_1\revopy\ML\Data\test_code\df_unq_df_random_1.csv" is 10001.
	 (SQL Server Import and Export Wizard)
	

- Copying to [dbo].[df_unq_df_random_1] (Success)
	* 10000 rows transferred

	Messages
	* Information 0x402090df: Data Flow Task 1: The final commit for the data insertion in "Destination - df_unq_df_random_1" has started.
	 (SQL Server Import and Export Wizard)
	
	* Information 0x402090e0: Data Flow Task 1: The final commit for the data insertion  in "Destination - df_unq_df_random_1" has ended.
	 (SQL Server Import and Export Wizard)
	

- Post-execute (Success)
	Messages
	* Information 0x402090dd: Data Flow Task 1: The processing of file "C:\21_01\gits_done_down\jan_21_1\revopy\ML\Data\test_code\df_unq_df_random_1.csv" has ended.
	 (SQL Server Import and Export Wizard)
	
	* Information 0x4004300b: Data Flow Task 1: "Destination - df_unq_df_random_1" wrote 10000 rows.
	 (SQL Server Import and Export Wizard)
	



##### FOOBAR--Import Export Wizard 
Value 	Description
{CR}{LF} 	The header row is delimited by a carriage return-line feed combination.




SELECT j.concat_cols , u.Col1 , u.Col2 , j.Item_1_purchaseCount , j.Item_2_purchaseCount
FROM test_csv.dbo.df_join AS j
JOIN test_csv.dbo.df_unq_df_random_1 AS u
ON j.concat_cols=u.concat_cols;


--DESCRIBE test_csv.dbo.df_join;
exec sp_columns df_join;



C:\21_01\gits_done_down\jan_21_1\revopy\ML\Data\test_code

/*CREATE VIEW dbo.view_df_unq
AS
SELECT j.concat_cols , u.Col1 , u.Col2 , j.Item_1_purchaseCount , j.Item_2_purchaseCount
FROM test_csv.dbo.df_join AS j
JOIN test_csv.dbo.df_unq_df_random_1 AS u
ON j.concat_cols = u.concat_cols;
*/

-- SELECT data from View 
/*SELECT * FROM view_df_unq */

-- sp_helptext ( call a stored proc to see details about the view)
/*sp_helptext view_df_unq */

-- filter data within VIEW with a WHERE clause
SELECT * FROM view_df_unq
WHERE view_df_unq.concat_cols='16.51810509828813_y_9862@yahoo.com';



#### FOOBAR - when we execute the proc == spGetCountGmail_9 , from SQLServer GUI 

USE [test_csv]
GO
DECLARE	@return_value int
EXEC	@return_value = [dbo].[spGetCountGmail_9]
SELECT	'Return Value' = @return_value
GO

#### FOOBAR - to view the DEFINITION of a PROC - we can use the GUI and get results as below
USE [test_csv]
GO

/****** Object:  StoredProcedure [dbo].[spGmailParams]    Script Date: 1/4/2021 7:49:45 AM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE PROC [dbo].[spGmailParams]
@param_email nvarchar(20),
@param_concat_cols nvarchar(20)
AS
BEGIN
	SELECT concat_cols FROM df_unq_df_random_1 WHERE RIGHT(concat_cols,9) = @param_email;
END
GO


#### FOOBAR --- ALTER PROC spGmailParams1
-- execute spGmailParams 'gmail.com' , 'gmail.com'
-- execute spGmailParams1 'gmail.com'

-- CREATE PROC spGmailParams1
ALTER PROC spGmailParams1
@param_email nvarchar(20),
-- @param_concat_cols nvarchar(20)
@param_int int
AS
BEGIN
	SELECT concat_cols FROM df_unq_df_random_1 
	WHERE RIGHT(concat_cols,9) = @param_email AND RIGHT(Col8,1) = @param_int
END


#### FOOBAR --- DROP PROC spGmailParams1

#### FOOBAR -- Own Error Solved 
pyodbc.ProgrammingError: ('42000', "[42000] [Microsoft][ODBC Driver 17 for SQL Server]
[SQL Server]Must pass parameter number 2 and subsequent parameters as '@name = value'. 
After the form '@name = value' has been used, all subsequent parameters must be passed in the form '@name = value'. 
(119) (SQLExecDirectW); [42000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]Statement(s) could not be prepared. (8180)")


File ".\pyodbc_1.py", line 61, in <module>
    cursor.execute("UPDATE test_pyodbc " +  "SET fullName = name + " " + email")
pyodbc.ProgrammingError: ('42000', "[42000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The SELECT permission was denied on the object 'test_pyodbc', database 'test_csv', schema 'dbo'. (229) (SQLExecDirectW); [42000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The UPDATE permission was denied on the object 'test_pyodbc', database 'test_csv',
schema 'dbo'. (229)")



